
fsurl="/fs/" -- used by index.lsp

local fmt=string.format
local examples={}
local hio=ba.openio("home")
require"wfs"

local type,plat=io:resourcetype()
local iswin = plat == "windows"
local io,conprint=io,print

------------------------------------------------------------------------
-- 'Visual Studio Code' launch.json template file.
local launchFmt=[[
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "attach",
            "type": "lua",
            "request": "attach",
            "stopOnEntry": true,
            "address": "%s:4711",
            "client":true,
            "sourceMaps": [
                [
                    "%s",
                    "http://%s/fs/%s"
                ]
    	    ]
         }
    ]
}
]]

local function directoryCB(_ENV, relpath)
   local ua=request:header"User-Agent"
   if examples[relpath] and ua and ua:find"^NetIO" then
      local dname=relpath..".vscode"
      if not hio:stat(dname) then hio:mkdir(dname) end
      local fname=dname.."/launch.json"
      conprint("Creating 'Visual Studio Code' config file:",fname)
      local fp,err=hio:open(fname,"w")
      if fp then
         local dbgmonIP=request:peername()
         local debuggerIP=request:sockname()
         local localpath=hio:realpath(relpath)
         if iswin then localpath=localpath:gsub("\\","\\\\") end
         local addr = mako.port == 80 and debuggerIP or fmt("%s:%d",debuggerIP,mako.port)
         fp:write(fmt("//Generated by: %s\n",io:realpath".preload"))
         fp:write(fmt(launchFmt,dbgmonIP,localpath,addr,relpath))
         fp:close()
         examples[relpath]=nil -- do not generate again
      else
         conprint(fmt("Error:, cannot open %s, %s",fname,err))
      end
   end
   return false
end

-- This function tries to find the computer's IP address and then sets fsurl
local function setURL()
   local s=ba.socket.connect("google.com", 80)
   if s then
      fsurl=fmt("http://%s:%d/fs/",s:sockname(),mako.port)
      s:close()
   end
end

local function start()
   setURL()
   local exDirs=0
   for name, isdir in hio:files("",true) do
      if isdir and name ~= "FileServer" and not name:find("^%.") then
         examples[name.."/"]=true
         exDirs=exDirs+1
      end
   end
   print"\n--------------------------------------------------------------------"
   print"--------------------------------------------------------------------"
   print("Creating NetIo file server with base:\n", hio:realpath"")
   if exDirs == 0 then
      print"Could not find any examples (sub directories) in this directory."
   else
      print(fmt("Watching the following %s:", exDirs == 1 and "directory" or "directories"))
      for name in pairs(examples) do print("",name) end
   end
   print"--------------------------------------------------------------------"
   print"--------------------------------------------------------------------\n\n"

   dir=ba.create.dir("fs")
   dir:insert()
   dir:insert(ba.create.wfs("", hio, ".LOCK"), true)
   dir:setfunc(directoryCB)
   io:dofile".lua/StartBrowser.lua"
end



ba.thread.run(start)
